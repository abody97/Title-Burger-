<!-- index.html --><!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>الجرد العام - تايتل برجر</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="manifest" href="manifest.json">
  <style>
    body { padding: 20px; background-color: #fff; font-family: 'Tajawal', sans-serif; }
    h2 { text-align: center; margin-bottom: 20px; }
    table input { width: 100%; border: none; background: transparent; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h2>📦 الجرد العام للمطعم</h2><div class="mb-3">
  <input type="text" class="form-control" id="searchInput" placeholder="🔍 ابحث عن صنف..." onkeyup="searchTable()">
</div>

<div class="d-flex flex-wrap gap-2 justify-content-between mb-3">
  <button class="btn btn-success" onclick="addRow()">➕ إضافة صنف</button>
  <a class="btn btn-dark" href="daily.html">📅 الجرد اليومي</a>
  <a class="btn btn-primary" href="stats.html">📊 الإحصائيات</a>
  <button class="btn btn-warning" onclick="saveData()">💾 حفظ</button>
  <button class="btn btn-info" onclick="loadData()">📂 تحميل</button>
  <button class="btn btn-secondary" onclick="window.print()">🖨️ طباعة</button>
  <button class="btn btn-danger" onclick="clearData()">🗑️ مسح</button>
  <button class="btn btn-outline-primary" onclick="exportToExcel()">📤 تصدير Excel</button>
</div>

<table class="table table-bordered text-center align-middle" id="inventory-table">
  <thead class="table-light">
    <tr>
      <th>#</th>
      <th>الصنف</th>
      <th>الوحدة</th>
      <th>المتوفر</th>
      <th>المصروف</th>
      <th>المتبقي</th>
      <th>تاريخ الجرد</th>
      <th>ملاحظات</th>
      <th>🛠️</th>
    </tr>
  </thead>
  <tbody id="inventory-body"></tbody>
</table>

  </div>  <script>
    let counter = 1;

    function addRow(item = {}) {
      const tbody = document.getElementById('inventory-body');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${counter}</td>
        <td><input type="text" value="${item.name || ''}" oninput="autoSave()"></td>
        <td><input type="text" value="${item.unit || ''}" oninput="autoSave()"></td>
        <td><input type="number" oninput="calcRemaining(this)" value="${item.available || ''}"></td>
        <td><input type="number" oninput="calcRemaining(this)" value="${item.used || ''}"></td>
        <td><input type="number" readonly></td>
        <td><input type="date" value="${item.date || new Date().toISOString().split('T')[0]}" oninput="autoSave()"></td>
        <td><input type="text" value="${item.notes || ''}" oninput="autoSave()"></td>
        <td><button class="btn btn-sm btn-danger" onclick="removeRow(this)">🗑️</button></td>
      `;
      tbody.appendChild(row);
      calcRemaining(row.querySelectorAll('input')[2]);
      counter++;
    }

    function calcRemaining(input) {
      const row = input.closest('tr');
      const available = parseFloat(row.children[3].querySelector('input').value) || 0;
      const used = parseFloat(row.children[4].querySelector('input').value) || 0;
      const remainingField = row.children[5].querySelector('input');
      const remaining = available - used;
      remainingField.value = remaining;
      remainingField.style.backgroundColor = (remaining <= 2) ? "#f8d7da" : "#d1e7dd";
      autoSave();
    }

    function removeRow(btn) {
      btn.closest('tr').remove();
      updateRowNumbers();
      autoSave();
    }

    function updateRowNumbers() {
      const rows = document.querySelectorAll('#inventory-body tr');
      counter = 1;
      rows.forEach((row) => row.children[0].textContent = counter++);
    }

    function saveData() {
      const rows = document.querySelectorAll('#inventory-body tr');
      const data = [];
      rows.forEach((row) => {
        const inputs = row.querySelectorAll('input');
        data.push({
          name: inputs[0].value,
          unit: inputs[1].value,
          available: inputs[2].value,
          used: inputs[3].value,
          remaining: inputs[4].value,
          date: inputs[5].value,
          notes: inputs[6].value,
        });
      });
      localStorage.setItem('inventoryData', JSON.stringify(data));
    }

    function loadData() {
      const data = JSON.parse(localStorage.getItem('inventoryData')) || [];
      document.getElementById('inventory-body').innerHTML = '';
      counter = 1;
      data.forEach(item => addRow(item));
    }

    function clearData() {
      if (confirm("🛑 هل أنت متأكد من مسح جميع بيانات الجرد؟")) {
        localStorage.removeItem('inventoryData');
        document.getElementById('inventory-body').innerHTML = '';
        counter = 1;
      }
    }

    function exportToExcel() {
      const table = document.getElementById('inventory-table');
      const wb = XLSX.utils.table_to_book(table, { sheet: "جرد عام" });
      XLSX.writeFile(wb, "جرد_عام.xlsx");
    }

    function searchTable() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#inventory-body tr");
      rows.forEach(row => {
        const name = row.children[1].querySelector('input').value.toLowerCase();
        row.style.display = name.includes(input) ? '' : 'none';
      });
    }

    function autoSave() {
      saveData();
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("✅ Service Worker مسجّل"))
        .catch(err => console.log("❌ Service Worker فشل:", err));
    }

    window.onload = loadData;
  </script></body>
</html>